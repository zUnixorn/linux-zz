on:
  push:
    branches: [master]
    paths:
      - '**.sh'
      - '.github/workflows/**'
  schedule:
    - cron: "4 2 * * *"
  workflow_dispatch: ~

name: Release

concurrency:
  group: release
  cancel-in-progress: true

permissions:
  contents: write

env:
  RELEASE_NAME: experimental-docker
  PKGBUILD_SHA256SUM: "3bcb02105c58946eb0c717cd5d853bd13fca6815249b1ec9b6ce9796d09a7d7b"

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    environment: Release

    steps:
      # - name: Free up more disk space
      #   uses: jlumbroso/free-disk-space@main
      #   with:
      #     tool-cache: true
      #     docker-images: false
      - name: Checkout code
        uses: actions/checkout@v4.2.2
      - name: Build build container
        run: docker build -t linux-zz-builder -f Containerfile .
      - name: Create output directory
        run: mkdir ./output
      - name: Build kernel
        env:
          GPG_KEY_ID: "${{ vars.GPG_KEY_ID }}"
          GPG_SIGNING_KEY: "${{ secrets.GPG_SIGNING_KEY_B64 }}"
        run: docker run -e GPG_SIGNING_KEY -e GPG_KEY_ID -e PKGBUILD_SHA256SUM --rm -v "$(pwd)/output:/output" linux-zz-builder:latest
      - name: Add public key to release
        run: echo -n "${{ vars.GPG_PUBLIC_KEY }}" > ./output/public.pgp
      - name: Release packages
        uses: ncipollo/release-action@v1.16.0
        with:
          name: ${{ env.RELEASE_NAME }}
          tag: ${{ env.RELEASE_NAME }}
          commit: ${{ github.sha }}
          artifacts: ./output/*
          allowUpdates: true
          artifactErrorsFailBuild: true
          omitBody: true
          omitBodyDuringUpdate: true
          removeArtifacts: true
